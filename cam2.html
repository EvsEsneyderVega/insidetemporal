<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Captura T√©cnica Fotogr√°fica</title>
<style>
    video, img {
        max-width: 400px;
        border: 2px solid #000;
        margin: 10px;
    }
</style>
</head>
<body>

<h2>Registro Fotogr√°fico T√©cnico-Mec√°nico</h2>

<label>Placa:</label>
<input type="text" id="placaInput" placeholder="Ej: ABC123" value="ABC123">
<br><br>

<select id="selectorCamara">
    <option value="user">C√°mara Frontal</option>
    <option value="environment" selected>C√°mara Trasera</option>
</select>
<button id="iniciar">Iniciar C√°mara</button>
<br><br>

<video id="video" autoplay playsinline></video>
<br>
<button id="capturar">üì∑ Capturar Imagen T√©cnica</button>
<br>
<canvas id="canvas" style="display:none;"></canvas>
<br>
<h3>Resultado:</h3>
<img id="fotoFinal" alt="Imagen t√©cnica capturada">

<script>
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const fotoFinal = document.getElementById('fotoFinal');
const placaInput = document.getElementById('placaInput');
const selectorCamara = document.getElementById('selectorCamara');
const btnIniciar = document.getElementById('iniciar');
const btnCapturar = document.getElementById('capturar');

let streamActual = null;

btnIniciar.addEventListener('click', () => {
    if (streamActual) {
        streamActual.getTracks().forEach(track => track.stop());
    }
    const modo = selectorCamara.value;
    navigator.mediaDevices.getUserMedia({ video: { facingMode: modo } })
        .then(stream => {
            video.srcObject = stream;
            streamActual = stream;
        })
        .catch(err => {
            console.error(err);
            alert('No se pudo acceder a la c√°mara.');
        });
});

btnCapturar.addEventListener('click', () => {
    canvas.width = 945;
    canvas.height = 825;
    const ctx = canvas.getContext('2d');

    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

    ctx.lineWidth = 2;
    ctx.strokeStyle = "black";
    ctx.strokeRect(0, 0, canvas.width, canvas.height);

    const ahora = new Date();
    const fecha = `${ahora.getFullYear()}-${String(ahora.getMonth()+1).padStart(2, '0')}-${String(ahora.getDate()).padStart(2, '0')}`;
    const hora = `${String(ahora.getHours()).padStart(2, '0')}:${String(ahora.getMinutes()).padStart(2, '0')}`;
    const placa = placaInput.value || "SIN PLACA";

    const textoSuperior = "Fotograf√≠a 1";
    const textoInferior = `Fecha: ${fecha}, PLACA: ${placa} HORA: ${hora} `;

    ctx.font = "30px Arial";
    const margen = 10;
    const padding = 5;

    // Medidas del texto
    const anchoTextoSup = ctx.measureText(textoSuperior).width;
    const altoTexto = 35;

    // Rect√°ngulo blanco para el texto superior
    ctx.fillStyle = "rgba(255,255,255,0.8)";
    ctx.fillRect(margen - padding, margen - padding, anchoTextoSup + padding*2, altoTexto + padding*2);

    // Dibujar el texto superior
    ctx.fillStyle = "black";
    ctx.fillText(textoSuperior, margen, margen + altoTexto);

    // Medidas del texto inferior
    const anchoTextoInf = ctx.measureText(textoInferior).width;

    // Rect√°ngulo blanco para el texto inferior
    ctx.fillStyle = "rgba(255,255,255,0.8)";
    ctx.fillRect(margen - padding, canvas.height - altoTexto - margen - padding, anchoTextoInf + padding*2, altoTexto + padding*2);

    // Dibujar el texto inferior
    ctx.fillStyle = "black";
    ctx.fillText(textoInferior, margen, canvas.height - margen);

    // Blanco y negro opcional
    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    const data = imageData.data;
    /*for (let i = 0; i < data.length; i += 4) {
        const gris = (data[i] + data[i+1] + data[i+2]) / 3;
        data[i] = gris;
        data[i+1] = gris;
        data[i+2] = gris;
    }*/
    ctx.putImageData(imageData, 0, 0);

    // Exportar
    const dataURL = canvas.toDataURL('image/jpeg', 0.9);
    fotoFinal.src = dataURL;
});

</script>

</body>
</html>
